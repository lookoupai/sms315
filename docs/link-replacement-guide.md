# 链接替换功能使用指南

## 功能概述

链接替换功能允许管理员设置原始链接和推广链接的映射关系，当用户在前端看到原始链接时，系统会自动替换为推广链接，从而增加收入转化。

## 主要特性

### 1. 性能优化
- **缓存机制**：替换规则缓存5分钟，减少数据库查询
- **全局状态管理**：避免重复请求，多个组件共享同一份数据
- **React优化**：使用 memo、useMemo、useCallback 等优化渲染性能
- **适配免费额度**：专门针对 Vercel 和 Supabase 免费额度进行优化

### 2. 匹配类型
- **精确匹配**：完全匹配URL，性能最好
- **域名匹配**：匹配整个域名，保留原URL的路径和参数
- **包含匹配**：URL中包含指定字符串即匹配

### 3. 智能替换
- **文本链接替换**：自动识别文本中的链接并替换
- **URL链接替换**：直接替换 `<a>` 标签的 href 属性
- **条件替换**：只在有替换规则时才处理，避免不必要的计算

## 使用方法

### 管理员操作

1. **登录管理后台**
   - 访问 `/admin` 页面
   - 输入管理员密码

2. **添加替换规则**
   - 点击"链接替换"标签页
   - 填写原始链接和推广链接
   - 选择匹配类型
   - 添加描述信息
   - 点击"添加替换规则"

3. **管理替换规则**
   - 查看所有替换规则列表
   - 编辑现有规则
   - 启用/禁用规则
   - 删除不需要的规则

### 前端应用

系统会在以下位置自动应用链接替换：

1. **首页展示**
   - 网站名称链接自动替换
   - 用户备注中的链接自动替换

2. **提交页面**
   - 备注预览中的链接自动替换

## 配置示例

### 示例1：SMS-Activate 推广链接
```
原始链接: https://sms-activate.io
推广链接: https://sms-activate.io/?ref=486565
匹配类型: 精确匹配
描述: SMS-Activate 推广链接
```

### 示例2：域名匹配
```
原始链接: sms-activate.io
推广链接: https://sms-activate.io/?ref=486565
匹配类型: 域名匹配
描述: SMS-Activate 域名匹配
```

## 技术实现

### 数据库表结构
```sql
CREATE TABLE link_replacements (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  original_url TEXT NOT NULL UNIQUE,
  replacement_url TEXT NOT NULL,
  match_type VARCHAR(20) DEFAULT 'exact',
  is_active BOOLEAN DEFAULT true,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 核心组件

1. **useLinkReplacement Hook**
   - 管理全局替换规则状态
   - 提供缓存和性能优化
   - 支持手动刷新

2. **LinkReplacer 组件**
   - TextLinkReplacer：文本链接替换
   - UrlLinkReplacer：URL链接替换
   - SmartLinkReplacer：智能链接替换
   - ConditionalLinkReplacer：条件链接替换

3. **linkReplacement 服务**
   - 数据库操作封装
   - 链接替换逻辑
   - 缓存管理

## 性能考虑

### 缓存策略
- 替换规则缓存5分钟
- 全局状态避免重复请求
- 组件级别的 memo 优化

### 免费额度优化
- 减少数据库查询频率
- 优化 React 渲染性能
- 智能缓存管理

### 匹配性能
- 精确匹配 > 域名匹配 > 包含匹配
- 按性能顺序执行匹配
- 避免不必要的正则表达式

## 注意事项

### 法律合规
- 确保推广链接使用符合相关法规
- 考虑添加推广链接透明度声明

### 用户体验
- 替换后的链接保持原有显示文本
- 确保替换不影响链接功能
- 添加适当的 rel 属性

### 技术风险
- 避免过度替换导致性能问题
- 确保替换逻辑不破坏现有功能
- 定期检查替换规则的有效性

## 故障排除

### 常见问题

1. **替换不生效**
   - 检查替换规则是否启用
   - 确认匹配类型设置正确
   - 清除缓存重新加载

2. **性能问题**
   - 检查替换规则数量
   - 优化匹配类型选择
   - 监控数据库查询频率

3. **链接错误**
   - 验证推广链接有效性
   - 检查URL格式正确性
   - 测试替换后的链接功能

### 调试方法
- 使用浏览器开发者工具检查网络请求
- 查看控制台错误信息
- 检查替换规则配置

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持三种匹配类型
- 完整的管理后台
- 性能优化和缓存机制
- 适配免费额度限制